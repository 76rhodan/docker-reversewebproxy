#!/bin/bash
#shellcheck shell=bash

#for testing purposes only, remove before flight
GEOIP_COUNTRIES="AA,BB,CC,DD"
GEOIP_DEFAULT=block
#for testing purposes only, remove before flight

APPNAME="$(hostname)/GeoIP"
#GEOIPDIR="/usr/share/GeoIP"
GEOIPDIR="/home/thomas1976/GeoIP"
echo "[$APPNAME][$(date)] Installing GeoIP Database and set up nginx configuration"
echo $geoipfail
# create GeoIP directory and install lates GeoIP DB
mkdir -p $GEOIPDIR

<<excluded
# get the GeoIP databases
geoipfail=false
! curl --fail -sL -o "$GEOIPDIR"/GeoIP.dat.gz https://mailfud.org/geoip-legacy/GeoIP.dat.gz && geoipfail=true || true
! curl --fail -sL -o "$GEOIPDIR"/GeoIPv6.dat.gz https://mailfud.org/geoip-legacy/GeoIPv6.dat.gz && geoipfail=true || true

# if we couldn't get the databases, let's fall back to another database:
if [[ "$geoipfail" == "true" ]]
then
  echo "we couldn't download the mailfud GeoIP DB. Now trying centminmod"
  curl --fail -sL -o "$GEOIPDIR"/GeoIP.dat.gz https://centminmod.com/centminmodparts/geoip-legacy/GeoIP.dat.gz && geoipfail=false || true
  curl --fail -sL -o "$GEOIPDIR"/GeoIPv6.dat.gz https://centminmod.com/centminmodparts/geoip-legacy/GeoIPv6.dat.gz && geoipfail=false || true
fi

[[ "$geoipfail" == "true" ]] && echo "[$APPNAME][$(date)] Couldn't retrieve any newer GeoIP databases. Your database may be out of date." || true

gunzip -f "$GEOIPDIR"/GeoIP.dat.gz
gunzip -f "$GEOIPDIR"/GeoIPv6.dat.gz
excluded

#read country codes from the variable 
IFS=“,” read -ra include_list <<< “$GEOIP_COUNTRIES”

#set the default GeoIP in /etc/nginx/nginx.conf
case "$GEOIP_DEFAULT" in
  allow|ALLOW)
  echo "Default is set to allow every country but block the listed"
  sed -i '/^http {.*/a     default yes;' /home/thomas1976/nginx.conf
  ;;

  block|BLOCK)
  echo "Default is set to block every country and only allow the listed"
  sed  '/^http {.*/a default no;' /home/thomas1976/nginx.conf #add -i again
  for a in ${include_list[@]}
    do
    sed -i "/^default no;.*/a $a yes;" /home/thomas1976/nginx.conf
  done
  ;;

  *)
  echo "Configuration not set or has a wrong value (use only allow or block). Defaulting to allow all"
  sed -i '/^http {.*/a     default yes;' /home/thomas1976/nginx.conf
esac
